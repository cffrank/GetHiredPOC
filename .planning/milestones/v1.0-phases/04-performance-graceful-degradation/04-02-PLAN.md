---
phase: 04-performance-graceful-degradation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/src/routes/linkedin.ts
  - packages/backend/src/services/linkedin.service.ts
  - packages/backend/src/services/job-matching.service.ts
  - packages/frontend/src/pages/Profile.tsx
autonomous: true
requirements:
  - GRACE-01
  - GRACE-02

must_haves:
  truths:
    - "Connecting LinkedIn when the API returns no profile data shows the user a notification explaining the limitation"
    - "AI response parsing returns a fallback template on malformed JSON instead of throwing and dropping the job"
    - "Jobs with failed AI analysis still appear in recommendations with a neutral fallback score"
  artifacts:
    - path: "packages/backend/src/routes/linkedin.ts"
      provides: "LinkedIn callback redirect with warning param on empty data"
      contains: "linkedin_limited_data"
    - path: "packages/backend/src/services/job-matching.service.ts"
      provides: "Fallback template in parseMatchJSON on malformed AI response"
      contains: "fallback"
    - path: "packages/frontend/src/pages/Profile.tsx"
      provides: "Toast notification for LinkedIn limited data warning"
      contains: "linkedin_limited_data"
  key_links:
    - from: "packages/backend/src/routes/linkedin.ts"
      to: "packages/frontend/src/pages/Profile.tsx"
      via: "redirect with ?warning=linkedin_limited_data query param"
      pattern: "linkedin_limited_data"
    - from: "packages/backend/src/services/job-matching.service.ts"
      to: "job-recommendations.service.ts"
      via: "parseMatchJSON returns fallback instead of throwing"
      pattern: "score.*50|fallback"
---

<objective>
Make LinkedIn integration and AI response parsing fail gracefully instead of silently swallowing errors.

Purpose: LinkedIn's basic OpenID Connect API returns empty positions/educations/skills arrays (Partner API required for full data). Currently the user sees a success redirect with no data imported. AI response parsing throws on malformed JSON, silently dropping jobs from recommendations. Both need user-visible feedback.

Output: LinkedIn callback detects empty data and redirects with warning param; Profile page shows explanatory toast; parseMatchJSON returns neutral fallback template instead of throwing.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance-graceful-degradation/04-RESEARCH.md

@packages/backend/src/routes/linkedin.ts
@packages/backend/src/services/linkedin.service.ts
@packages/backend/src/services/job-matching.service.ts
@packages/frontend/src/pages/Profile.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: LinkedIn empty data detection with user notification</name>
  <files>
    packages/backend/src/routes/linkedin.ts
    packages/backend/src/services/linkedin.service.ts
    packages/frontend/src/pages/Profile.tsx
  </files>
  <action>
1. In `linkedin.service.ts`, add a helper function `hasLinkedInData(profile: LinkedInProfile): boolean` that returns true if `profile.positions.length > 0 || profile.educations.length > 0 || profile.skills.length > 0`. Export it.

2. In `linkedin.ts` callback route, after calling `fetchLinkedInProfile(accessToken)`:
   - Import and call `hasLinkedInData(linkedInProfile)`
   - If `hasLinkedInData` returns false: still call `saveLinkedInProfile` (to save name/email if available), then redirect with `?warning=linkedin_limited_data` instead of the normal success redirect
   - If true: proceed with normal save and redirect with success param (e.g., `?success=linkedin_imported`)

3. In `packages/frontend/src/pages/Profile.tsx`:
   - On component mount (or in existing useEffect), read `window.location.search` for `warning=linkedin_limited_data`
   - If found, show a toast notification (using the project's existing toast system — sonner in packages/frontend, or the custom Toast component in src/app): "LinkedIn connected, but only basic info (name and email) was imported. Work history, education, and skills require LinkedIn Partner Program access."
   - Clean the URL param after showing the toast (using `window.history.replaceState`)
   - Check which toast system Profile.tsx uses (packages/frontend uses sonner; src/app uses custom Toast) and use the appropriate one

NOTE: The rwsdk app's Profile is at `src/app/pages/Profile.tsx`. The packages/frontend Profile is at `packages/frontend/src/pages/Profile.tsx`. Check both — the LinkedIn callback will redirect to whichever the user is using. Update the one that handles the LinkedIn redirect (check the redirect URL in linkedin.ts to determine which).
  </action>
  <verify>
- `grep "linkedin_limited_data" packages/backend/src/routes/linkedin.ts` returns a match
- `grep "hasLinkedInData" packages/backend/src/services/linkedin.service.ts` returns a match
- The frontend Profile page handles the `warning=linkedin_limited_data` query param
- TypeScript compiles: `npx tsc --noEmit` in relevant workspaces
  </verify>
  <done>LinkedIn callback detects empty profile data and redirects with warning param; frontend Profile page shows explanatory toast to user</done>
</task>

<task type="auto">
  <name>Task 2: AI response fallback template for malformed JSON</name>
  <files>
    packages/backend/src/services/job-matching.service.ts
  </files>
  <action>
1. In `job-matching.service.ts`, find the `parseMatchJSON` function (or equivalent that parses AI analysis JSON responses).

2. Modify the catch block to return a neutral fallback template instead of throwing:
   ```typescript
   catch (error) {
     console.error('[Job Match] Parse error, using fallback template:', error);
     return {
       score: 50,
       strengths: ['Unable to analyze at this time'],
       concerns: ['Analysis temporarily unavailable'],
       recommendation: 'fair',
       summary: 'Analysis could not be completed. Please try again.'
     };
   }
   ```
   If plan 01 has already executed and the structured logger is available, use `logger.error(...)` instead of `console.error(...)`. If not, use console.error and it will be converted when plan 01 runs.

3. Also check if `analyzeJobMatch` itself has a try/catch that throws or returns null on parse failure. If it catches and skips the job entirely, update it to use the fallback result so the job still appears in recommendations (with a neutral score of 50).

4. Verify the return type of the fallback matches the expected type interface (check the return type annotation or the interface used by callers). Ensure `score`, `strengths`, `concerns`, `recommendation`, and `summary` fields are all present and correctly typed.
  </action>
  <verify>
- `grep -A5 "catch.*error" packages/backend/src/services/job-matching.service.ts` shows fallback template return instead of throw
- TypeScript compiles: `cd packages/backend && npx tsc --noEmit`
- The fallback object shape matches the expected return type of parseMatchJSON
  </verify>
  <done>parseMatchJSON returns a neutral fallback template (score: 50) on malformed JSON instead of throwing; jobs with failed AI analysis still appear in recommendations</done>
</task>

</tasks>

<verification>
- LinkedIn callback route handles empty profile data with warning redirect
- Frontend Profile page displays toast for linkedin_limited_data warning
- AI response parsing never throws on malformed JSON — returns fallback template
- All TypeScript compiles cleanly
</verification>

<success_criteria>
- Connecting LinkedIn with empty API data shows user a notification explaining the limitation
- AI parse failures produce a neutral fallback (score 50) instead of dropping the job
- No new TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance-graceful-degradation/04-02-SUMMARY.md`
</output>
