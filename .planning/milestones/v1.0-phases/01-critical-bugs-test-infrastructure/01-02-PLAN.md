---
phase: 01-critical-bugs-test-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/src/pages/JobDetail.tsx
  - packages/frontend/src/hooks/useApplications.ts
autonomous: true
requirements:
  - BUG-01
  - BUG-03

must_haves:
  truths:
    - "Navigating to a JobDetail page with malformed requirements JSON does not crash — it displays an empty requirements section"
    - "Clicking Update Status on an application waits for API confirmation before reflecting the change, and rolls back if the API fails"
    - "If the status update API call fails, the card returns to its previous column"
  artifacts:
    - path: "packages/frontend/src/pages/JobDetail.tsx"
      provides: "Safe JSON parse for job requirements"
      contains: "safeParseJSON"
    - path: "packages/frontend/src/hooks/useApplications.ts"
      provides: "Optimistic update with rollback on useUpdateApplication"
      contains: "onMutate"
  key_links:
    - from: "packages/frontend/src/pages/JobDetail.tsx"
      to: "job.requirements"
      via: "safeParseJSON wrapper instead of raw JSON.parse"
      pattern: "safeParseJSON.*requirements"
    - from: "packages/frontend/src/hooks/useApplications.ts"
      to: "queryClient cache"
      via: "onMutate snapshot → onError rollback → onSettled invalidate"
      pattern: "onMutate.*onError.*onSettled"
---

<objective>
Fix two frontend crashes: the JobDetail JSON parse crash (BUG-01) and the missing optimistic update rollback on status changes (BUG-03).

Purpose: These two bugs cause visible crashes or silent data inconsistency for real users. Fixing them makes the core job-viewing and application-tracking flows reliable.
Output: Two patched frontend files with safe JSON parsing and proper mutation rollback.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bugs-test-infrastructure/01-RESEARCH.md
@packages/frontend/src/pages/JobDetail.tsx
@packages/frontend/src/hooks/useApplications.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix JobDetail JSON parse crash with safe parse helper</name>
  <files>packages/frontend/src/pages/JobDetail.tsx</files>
  <action>
1. Add a `safeParseJSON` helper function at the top of `JobDetail.tsx` (above the component, below imports):
   ```typescript
   function safeParseJSON<T>(value: string | null | undefined, fallback: T): T {
     if (!value) return fallback;
     try {
       return JSON.parse(value) as T;
     } catch {
       return fallback;
     }
   }
   ```

2. Replace the crash line (currently line 55):
   ```typescript
   // BEFORE (crashes on invalid JSON):
   const requirements = job.requirements ? JSON.parse(job.requirements) : [];

   // AFTER (returns empty array on invalid JSON):
   const requirements = safeParseJSON<string[]>(job.requirements, []);
   ```

3. Do NOT add an error boundary — that is Phase 3 scope (ERR-03). The fallback to `[]` satisfies Phase 1's success criterion: "displays a fallback state" (empty requirements section).

4. Verify the fix compiles: `npx tsc --noEmit -p packages/frontend/tsconfig.json`
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/frontend/tsconfig.json` — no new type errors. Visually confirm `safeParseJSON` replaced `JSON.parse` at the requirements line. Component tests for this fix will be added in Phase 5 (TEST-04).
  </verify>
  <done>JobDetail.tsx uses safeParseJSON for job.requirements — malformed JSON returns an empty array instead of crashing the component tree.</done>
</task>

<task type="auto">
  <name>Task 2: Add optimistic update with rollback to useUpdateApplication</name>
  <files>packages/frontend/src/hooks/useApplications.ts</files>
  <action>
1. In `useUpdateApplication()`, replace the current `useMutation` config with the full optimistic update pattern. The current code has only `mutationFn` and `onSuccess` (with `invalidateQueries`). Replace with:

   ```typescript
   export function useUpdateApplication() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: ({ id, updates }: { id: string; updates: any }) =>
         apiClient.updateApplication(id, updates),

       onMutate: async ({ id, updates }) => {
         // 1. Cancel in-flight refetches to prevent overwriting optimistic update
         await queryClient.cancelQueries({ queryKey: ['applications'] });

         // 2. Snapshot current cache for rollback
         const previousApplications = queryClient.getQueryData(['applications']);

         // 3. Optimistically update the cache
         queryClient.setQueryData(['applications'], (old: any) => ({
           ...old,
           applications: old?.applications?.map((app: any) =>
             app.id === id ? { ...app, ...updates } : app
           ),
         }));

         // 4. Return snapshot for rollback in onError
         return { previousApplications };
       },

       onError: (_err, _vars, context) => {
         // Roll back to snapshot on API failure
         if (context?.previousApplications) {
           queryClient.setQueryData(['applications'], context.previousApplications);
         }
       },

       onSettled: () => {
         // Always reconcile with server after mutation settles (success or failure)
         queryClient.invalidateQueries({ queryKey: ['applications'] });
       },
     });
   }
   ```

   CRITICAL: `cancelQueries` MUST be the first line of `onMutate` — without it, a background refetch can overwrite the optimistic update with stale data (see research pitfall #1).

   CRITICAL: Remove the old `onSuccess` callback — `onSettled` replaces it (runs on both success AND failure).

   NOTE: The `updates: any` type annotation is intentional — Phase 2 (TYPE-01) will replace it with a proper typed interface. Do not block this fix on typing.

2. Verify the fix compiles: `npx tsc --noEmit -p packages/frontend/tsconfig.json`
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/frontend/tsconfig.json` — no new type errors. Verify that `onMutate`, `onError`, and `onSettled` are all present in useUpdateApplication. Verify that the old standalone `onSuccess` is removed.
  </verify>
  <done>useUpdateApplication has onMutate (snapshot + optimistic cache update), onError (rollback to snapshot), and onSettled (invalidate queries). Failed API calls restore the previous application state.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/frontend/tsconfig.json` passes
2. JobDetail.tsx contains `safeParseJSON` and no raw `JSON.parse` for requirements
3. useApplications.ts `useUpdateApplication` contains `onMutate`, `onError`, and `onSettled`
4. No `onSuccess` remains as a standalone callback in useUpdateApplication (replaced by onSettled)
</verification>

<success_criteria>
- JobDetail page with malformed requirements JSON renders without crashing (empty requirements section)
- Status update mutation snapshots cache before mutating, rolls back on error, and reconciles on settle
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bugs-test-infrastructure/01-02-SUMMARY.md`
</output>
