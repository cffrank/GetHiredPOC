---
phase: 02-type-safety-input-validation
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - packages/backend/src/services/db.service.ts
  - packages/backend/src/routes/applications.ts
  - packages/backend/src/routes/profile.ts
  - packages/backend/src/routes/jobs.ts
  - packages/backend/src/routes/chat.ts
  - packages/backend/src/routes/auth.ts
  - packages/backend/src/routes/resumes.ts
  - packages/backend/src/routes/work-experience.ts
  - packages/backend/src/routes/education.ts
  - packages/backend/src/routes/job-preferences.ts
  - packages/backend/src/routes/email-preferences.ts
  - packages/backend/src/routes/linkedin.ts
  - packages/backend/src/routes/admin.ts
  - packages/backend/src/routes/export.ts
  - packages/backend/src/schemas/validation-hook.ts
  - packages/backend/src/schemas/auth.schema.ts
  - packages/backend/src/schemas/applications.schema.ts
  - packages/backend/src/schemas/profile.schema.ts
  - packages/backend/src/schemas/work-experience.schema.ts
  - packages/backend/src/schemas/education.schema.ts
  - packages/backend/src/schemas/job-preferences.schema.ts
  - packages/backend/src/schemas/email-preferences.schema.ts
  - packages/backend/src/schemas/chat.schema.ts
  - packages/backend/src/schemas/linkedin.schema.ts
  - packages/backend/src/schemas/admin.schema.ts
  - packages/backend/src/schemas/export.schema.ts
autonomous: true
requirements:
  - TYPE-01
  - VALID-01
  - VALID-02
  - VALID-03

must_haves:
  truths:
    - "TypeScript compiles with zero `any` usages in API handler files — all request and response shapes have named interfaces"
    - "ALL POST/PUT/PATCH routes across all route files use zValidator middleware — verified by grep showing no unguarded JSON body routes (every c.req.json() replaced with c.req.valid('json'))"
    - "Submitting a malformed request body to any POST/PUT/PATCH endpoint returns HTTP 400 with structured field-level error JSON, not a 500"
    - "The existing auth middleware (requireAuth from auth.middleware.ts) is used everywhere — no local c: any copies remain in route files"
    - "c.req.valid('json') is used after zValidator middleware instead of c.req.json() for typed access"
  artifacts:
    - path: "packages/backend/src/schemas/validation-hook.ts"
      provides: "Shared validation error hook for zValidator"
      exports: ["validationHook"]
    - path: "packages/backend/src/schemas/auth.schema.ts"
      provides: "Zod schemas for signup and login"
      exports: ["signupSchema", "loginSchema"]
    - path: "packages/backend/src/schemas/applications.schema.ts"
      provides: "Zod schemas for create/update application"
      exports: ["createApplicationSchema", "updateApplicationSchema"]
    - path: "packages/backend/src/schemas/profile.schema.ts"
      provides: "Zod schemas for profile update"
      exports: ["updateProfileSchema"]
    - path: "packages/backend/src/schemas/work-experience.schema.ts"
      provides: "Zod schemas for create/update work experience"
      exports: ["createWorkExperienceSchema", "updateWorkExperienceSchema"]
    - path: "packages/backend/src/schemas/education.schema.ts"
      provides: "Zod schemas for create/update education"
      exports: ["createEducationSchema", "updateEducationSchema"]
    - path: "packages/backend/src/schemas/job-preferences.schema.ts"
      provides: "Zod schema for update job preferences"
      exports: ["updateJobPreferencesSchema"]
    - path: "packages/backend/src/schemas/email-preferences.schema.ts"
      provides: "Zod schema for update email preferences"
      exports: ["updateEmailPreferencesSchema"]
    - path: "packages/backend/src/schemas/chat.schema.ts"
      provides: "Zod schemas for chat message and conversation creation"
      exports: ["chatMessageSchema", "createConversationSchema"]
    - path: "packages/backend/src/schemas/linkedin.schema.ts"
      provides: "Zod schema for linkedin parse"
      exports: ["linkedinParseSchema"]
    - path: "packages/backend/src/schemas/admin.schema.ts"
      provides: "Zod schemas for admin routes (role update, prompts)"
      exports: ["updateRoleSchema", "createPromptSchema", "updatePromptSchema"]
    - path: "packages/backend/src/schemas/export.schema.ts"
      provides: "Zod schema for cover letter export"
      exports: ["coverLetterExportSchema"]
  key_links:
    - from: "packages/backend/src/routes/auth.ts"
      to: "packages/backend/src/schemas/auth.schema.ts"
      via: "zValidator middleware import"
      pattern: "zValidator.*signupSchema"
    - from: "packages/backend/src/routes/applications.ts"
      to: "packages/backend/src/schemas/applications.schema.ts"
      via: "zValidator middleware import"
      pattern: "zValidator.*createApplicationSchema"
    - from: "packages/backend/src/routes/applications.ts"
      to: "@gethiredpoc/shared"
      via: "ApplicationUpdate type import"
      pattern: "import.*ApplicationUpdate.*from.*@gethiredpoc/shared"
    - from: "packages/backend/src/routes/profile.ts"
      to: "packages/backend/src/schemas/profile.schema.ts"
      via: "zValidator middleware import"
      pattern: "zValidator.*updateProfileSchema"
    - from: "packages/backend/src/routes/work-experience.ts"
      to: "packages/backend/src/schemas/work-experience.schema.ts"
      via: "zValidator middleware import"
      pattern: "zValidator.*createWorkExperienceSchema"
    - from: "packages/backend/src/routes/education.ts"
      to: "packages/backend/src/schemas/education.schema.ts"
      via: "zValidator middleware import"
      pattern: "zValidator.*createEducationSchema"
    - from: "packages/backend/src/routes/chat.ts"
      to: "packages/backend/src/schemas/chat.schema.ts"
      via: "zValidator middleware import"
      pattern: "zValidator.*chatMessageSchema"
    - from: "packages/backend/src/routes/*.ts"
      to: "packages/backend/src/middleware/auth.middleware.ts"
      via: "import requireAuth"
      pattern: "import.*requireAuth.*from.*middleware/auth"
---

<objective>
Replace all `any` types in API handler files with proper TypeScript interfaces and wire Zod validation middleware on every POST/PUT/PATCH route that accepts a JSON body.

Purpose: TYPE-01 requires zero `any` in handler files. VALID-01/02/03 require every endpoint to validate its request body with @hono/zod-validator before the handler runs, returning structured 400 errors on malformed input. This plan uses the shared types created in Plan 01 and the zod dependencies already installed.

Output: All route handler files free of `any`, Zod schemas for each route group, validation middleware wired on all 7+ JSON body routes, structured error responses on validation failure.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-type-safety-input-validation/02-RESEARCH.md
@.planning/phases/02-type-safety-input-validation/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Eliminate all any types from route handler files</name>
  <files>
    packages/backend/src/services/db.service.ts
    packages/backend/src/routes/applications.ts
    packages/backend/src/routes/profile.ts
    packages/backend/src/routes/jobs.ts
    packages/backend/src/routes/chat.ts
    packages/backend/src/routes/auth.ts
    packages/backend/src/routes/resumes.ts
    packages/backend/src/routes/work-experience.ts
    packages/backend/src/routes/education.ts
    packages/backend/src/routes/job-preferences.ts
    packages/backend/src/routes/email-preferences.ts
    packages/backend/src/routes/linkedin.ts
  </files>
  <action>
1. Fix `AI: any` in the `Env` interface in `packages/backend/src/services/db.service.ts`:
   - Add `import type { Ai } from '@cloudflare/workers-types'` at top
   - Change `AI: any` to `AI: Ai`
   - If TypeScript complains about model string arguments in `env.AI.run()` calls elsewhere, cast the model ID: `env.AI.run(modelId as any, options)` — this is acceptable because the Ai generic's model list may not include all gateway models, and it is a single controlled cast vs pervasive `any`

2. Delete local `requireAuth` function definitions from these route files (they use `c: any`):
   - `packages/backend/src/routes/applications.ts` (line ~21)
   - `packages/backend/src/routes/profile.ts` (line ~14)
   - `packages/backend/src/routes/jobs.ts` (lines ~22, ~29)
   - `packages/backend/src/routes/chat.ts` (line ~20)

   Replace with import from the properly-typed middleware:
   ```typescript
   import { requireAuth } from '../middleware/auth.middleware'
   ```

   Then update each route handler that called the local `requireAuth(c)` to use the middleware pattern. Check how `auth.middleware.ts` exposes auth — it likely uses `c.set('user', user)` so handlers access via `c.get('user')`. If the local requireAuth returned the user directly (e.g., `const user = await requireAuth(c)`), refactor each call site to use `c.get('user')` instead, after applying requireAuth as middleware.

3. Replace `updates: any = {}` in `applications.ts` (lines ~77, ~116) with a properly typed object using `ApplicationUpdate` from `@gethiredpoc/shared`:
   ```typescript
   import type { ApplicationUpdate } from '@gethiredpoc/shared'
   const updates: ApplicationUpdate = {}
   ```

4. Replace `updates: any = {}` and `params: any[]` in `profile.ts` (lines ~47, ~130, ~86) with proper types. For `params: any[]`, determine the actual types from the SQL query parameters and use a union type or `(string | number | null)[]`.

5. Search ALL route files for remaining `: any` annotations (including `result: any`, `data: any`, `body: any`, `response: any`). Replace each with the correct type:
   - `body: any` from `c.req.json()` → will be replaced by `c.req.valid('json')` in Task 2, but for routes without validation, type the parsed body with the appropriate interface
   - `result: any` from DB queries → type with the expected row shape
   - Generic `any` function parameters → use proper types from shared package or define local interfaces

6. Run `grep -rn ": any" packages/backend/src/routes/` to find ALL remaining `any` annotations. The goal is ZERO `: any` in route handler files. Note: `as any` casts for legitimate escape hatches (like AI model IDs) are acceptable if documented with a comment explaining why.

IMPORTANT: Read `packages/backend/src/middleware/auth.middleware.ts` first to understand how the typed requireAuth works before replacing local copies. The middleware version may work differently (middleware vs direct call).
  </action>
  <verify>
- `grep -rn ": any" packages/backend/src/routes/` returns zero results (excluding comments and `as any` casts with justification)
- `grep -rn "requireAuth" packages/backend/src/routes/ | grep -v "import"` — no local function definitions, only calls/middleware usage
- `cd packages/backend && npx tsc --noEmit` — compiles with no errors
  </verify>
  <done>Zero `: any` annotations in route handler files. All route files import requireAuth from middleware. Env.AI typed as Ai. All updates/params variables properly typed.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod schemas and wire validation middleware on all JSON body routes</name>
  <files>
    packages/backend/src/schemas/validation-hook.ts
    packages/backend/src/schemas/auth.schema.ts
    packages/backend/src/schemas/applications.schema.ts
    packages/backend/src/schemas/profile.schema.ts
    packages/backend/src/schemas/work-experience.schema.ts
    packages/backend/src/schemas/education.schema.ts
    packages/backend/src/schemas/job-preferences.schema.ts
    packages/backend/src/schemas/email-preferences.schema.ts
    packages/backend/src/schemas/chat.schema.ts
    packages/backend/src/schemas/linkedin.schema.ts
    packages/backend/src/schemas/admin.schema.ts
    packages/backend/src/schemas/export.schema.ts
    packages/backend/src/routes/auth.ts
    packages/backend/src/routes/applications.ts
    packages/backend/src/routes/profile.ts
    packages/backend/src/routes/work-experience.ts
    packages/backend/src/routes/education.ts
    packages/backend/src/routes/job-preferences.ts
    packages/backend/src/routes/email-preferences.ts
    packages/backend/src/routes/chat.ts
    packages/backend/src/routes/linkedin.ts
    packages/backend/src/routes/admin.ts
    packages/backend/src/routes/export.ts
  </files>
  <action>
1. Create `packages/backend/src/schemas/` directory.

2. Create `packages/backend/src/schemas/validation-hook.ts` — the shared error hook:
   ```typescript
   import type { Context } from 'hono'
   import type { ZodError } from 'zod'

   export function validationHook(
     result: { success: boolean; error?: ZodError },
     c: Context
   ) {
     if (!result.success && result.error) {
       return c.json({
         error: 'Validation failed',
         issues: result.error.errors.map(e => ({
           field: e.path.join('.'),
           message: e.message,
         })),
       }, 400)
     }
   }
   ```

3. Create `packages/backend/src/schemas/auth.schema.ts`:
   ```typescript
   import { z } from 'zod'

   export const signupSchema = z.object({
     email: z.string().email('Invalid email address'),
     password: z.string().min(8, 'Password must be at least 8 characters'),
     name: z.string().min(1, 'Name is required').optional(),
   })

   export const loginSchema = z.object({
     email: z.string().email('Invalid email address'),
     password: z.string().min(1, 'Password is required'),
   })
   ```
   IMPORTANT: Before writing these schemas, read the actual route handler to see what fields the handler extracts from the body. Match the schema to what the handler expects — do not invent fields. If the handler also reads `name` or `full_name`, include it. If not, omit it.

4. Create `packages/backend/src/schemas/applications.schema.ts`:
   ```typescript
   import { z } from 'zod'

   export const createApplicationSchema = z.object({
     job_id: z.string().min(1, 'job_id is required'),
     status: z.enum(['saved', 'applied', 'screening', 'interview', 'offer', 'rejected']).optional(),
   })

   export const updateApplicationSchema = z.object({
     status: z.enum(['saved', 'applied', 'screening', 'interview', 'offer', 'rejected']).optional(),
     notes: z.string().nullable().optional(),
     ai_match_score: z.number().min(0).max(100).nullable().optional(),
     ai_analysis: z.string().nullable().optional(),
   })
   ```
   Add `.refine(obj => Object.keys(obj).length > 0, { message: 'At least one field required' })` to updateApplicationSchema if the handler requires at least one field.

5. Create `packages/backend/src/schemas/profile.schema.ts`:
   Read `packages/backend/src/routes/profile.ts` to see exactly what fields the JSON body update path accepts. Create a schema matching those fields. IMPORTANT: The profile route handles BOTH JSON and FormData (dual content-type). The zValidator middleware should ONLY be applied to the JSON path. Two approaches:
   - Option A (preferred): Inside the handler, check content-type. If JSON, manually call `schema.safeParse(body)`. If FormData, skip validation.
   - Option B: Split into separate routes — `PUT /api/profile` for JSON, `POST /api/profile/avatar` for FormData. Only use if the route is already structured to support this.
   Document which approach was chosen.

6. Wire `zValidator('json', schema, validationHook)` middleware on each route that accepts a JSON body:
   - `POST /auth/signup` → signupSchema
   - `POST /auth/login` → loginSchema
   - `POST /applications` → createApplicationSchema
   - `PUT /applications/:id` → updateApplicationSchema
   - `PATCH /applications/:id` → updateApplicationSchema
   - `PUT /profile` or `PATCH /profile` → use manual safeParse for the JSON branch (see step 5)

   For each route, add the import:
   ```typescript
   import { zValidator } from '@hono/zod-validator'
   import { signupSchema } from '../schemas/auth.schema'
   import { validationHook } from '../schemas/validation-hook'
   ```

7. After wiring zValidator, replace `c.req.json()` calls in validated routes with `c.req.valid('json')` — this returns the typed, validated body. Remove any manual `if (!email || !password)` guards that are now redundant because the schema guarantees these fields exist.

8. Create schemas and wire zValidator for ALL remaining JSON-body route groups. Read each route file first to discover the exact fields the handler extracts from `c.req.json()`:

   a. `packages/backend/src/schemas/work-experience.schema.ts` — Create `createWorkExperienceSchema` and `updateWorkExperienceSchema`. Wire on `POST /` and `PUT /:id` in `work-experience.ts`.

   b. `packages/backend/src/schemas/education.schema.ts` — Create `createEducationSchema` and `updateEducationSchema`. Wire on `POST /` and `PUT /:id` in `education.ts`.

   c. `packages/backend/src/schemas/job-preferences.schema.ts` — Create `updateJobPreferencesSchema`. Wire on `PUT /` in `job-preferences.ts`.

   d. `packages/backend/src/schemas/email-preferences.schema.ts` — Create `updateEmailPreferencesSchema`. Wire on `PUT /` in `email-preferences.ts`.

   e. `packages/backend/src/schemas/chat.schema.ts` — Create `chatMessageSchema` (for `POST /message`) and `createConversationSchema` (for `POST /conversations`). Wire on both routes in `chat.ts`.

   f. `packages/backend/src/schemas/linkedin.schema.ts` — Create `linkedinParseSchema`. Wire on `POST /parse` in `linkedin.ts`.

   g. `packages/backend/src/schemas/admin.schema.ts` — Create `updateRoleSchema` (for `PUT /users/:userId/role`), `createPromptSchema` (for `POST /prompts`), `updatePromptSchema` (for `PUT /prompts/:key`). Wire on all three routes in `admin.ts`. For `POST /import-jobs` and `POST /import-jobs-for-user/:userId`, check if they read a JSON body — if they only use URL params, no schema needed.

   h. `packages/backend/src/schemas/export.schema.ts` — Create `coverLetterExportSchema`. Wire on `POST /cover-letter/:format` in `export.ts`.

   For each schema: read the route handler, identify all fields extracted from the body, match the schema exactly. Use `.passthrough()` if the frontend may send extra fields. Replace `c.req.json()` with `c.req.valid('json')` after wiring.

9. Final completeness check — run `grep -rn "c.req.json()" packages/backend/src/routes/` to confirm ZERO remaining unvalidated `c.req.json()` calls across ALL route files. Every JSON body route must use `c.req.valid('json')` instead. Also run `grep -rn "zValidator" packages/backend/src/routes/` to confirm every route file with JSON body endpoints imports and uses zValidator.

CRITICAL: Audit `packages/frontend/src/lib/api-client.ts` to verify the frontend sends fields matching these schemas. The STATE.md blocker says: "Audit actual frontend request shapes before writing Zod schemas." Read the api-client to check what fields each endpoint sends. If the frontend sends extra fields not in the schema, use `.passthrough()` on the Zod schema to avoid rejecting them. If the frontend omits fields the schema requires, make those fields optional.
  </action>
  <verify>
- `grep -rn "c.req.json()" packages/backend/src/routes/` — ZERO results across ALL route files (every JSON body route now uses c.req.valid('json'))
- `grep -rn "zValidator" packages/backend/src/routes/` — shows zValidator usage in auth.ts, applications.ts, profile.ts, work-experience.ts, education.ts, job-preferences.ts, email-preferences.ts, chat.ts, linkedin.ts, admin.ts, export.ts (all route files with JSON body endpoints)
- `cd packages/backend && npx tsc --noEmit` — compiles with no errors
- `npm test --workspace=packages/backend` — existing tests still pass
  </verify>
  <done>ALL POST/PUT/PATCH routes with JSON bodies across every route file have Zod validation middleware. Zero c.req.json() calls remain — all replaced with c.req.valid('json'). Malformed requests return 400 with structured field-level error details. Profile route handles dual content-type correctly.</done>
</task>

</tasks>

<verification>
1. `grep -rn ": any" packages/backend/src/routes/` → zero matches (excluding justified `as any` casts)
2. `grep -rn "catch (error: any)" packages/backend/src/` → zero matches (from Plan 01)
3. `grep -rn "c.req.json()" packages/backend/src/routes/` → ZERO matches across ALL route files (completeness check — every JSON body route uses c.req.valid)
4. `grep -rn "zValidator" packages/backend/src/routes/` → shows usage in all 11 route files with JSON body endpoints (auth, applications, profile, work-experience, education, job-preferences, email-preferences, chat, linkedin, admin, export)
5. `cd packages/backend && npx tsc --noEmit` → no errors
6. `npm test --workspace=packages/backend` → tests pass
</verification>

<success_criteria>
- Zero `: any` in API handler files (route files)
- ALL POST/PUT/PATCH JSON body routes across ALL route files have zValidator middleware — verified by zero remaining c.req.json() calls and zValidator present in all 11 applicable route files
- Malformed requests return HTTP 400 with `{ error: "Validation failed", issues: [{ field, message }] }` format
- Profile route dual content-type handled correctly (JSON validated, FormData passes through)
- requireAuth imported from middleware everywhere — no local copies
- TypeScript compiles cleanly across backend and shared packages
</success_criteria>

<output>
After completion, create `.planning/phases/02-type-safety-input-validation/02-02-SUMMARY.md`
</output>
