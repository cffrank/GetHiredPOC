---
phase: 03-security-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/src/index.ts
  - src/app/headers.ts
  - packages/backend/src/routes/resumes.ts
  - src/app/api/resume-upload.ts
autonomous: true
requirements:
  - SEC-01
  - SEC-03
  - SEC-04

must_haves:
  truths:
    - "Every HTTP response from the backend API includes CSP, HSTS, and X-Frame-Options headers"
    - "The rwsdk app includes X-Frame-Options header and tightened CSP directives"
    - "Uploading a file with .pdf extension but non-PDF binary content is rejected with 400 before parsing"
    - "Expired sessions are cleaned up by the daily cron job"
  artifacts:
    - path: "packages/backend/src/index.ts"
      provides: "secureHeaders middleware + session cleanup in scheduled handler"
      contains: "secureHeaders"
    - path: "src/app/headers.ts"
      provides: "X-Frame-Options header + tightened CSP"
      contains: "X-Frame-Options"
    - path: "packages/backend/src/routes/resumes.ts"
      provides: "Magic byte validation before resume parsing"
      contains: "validateFileMagicBytes"
    - path: "src/app/api/resume-upload.ts"
      provides: "Magic byte validation before resume upload processing"
      contains: "validateFileMagicBytes"
  key_links:
    - from: "packages/backend/src/index.ts"
      to: "hono/secure-headers"
      via: "secureHeaders middleware applied before routes"
      pattern: "app\\.use.*secureHeaders"
    - from: "packages/backend/src/index.ts"
      to: "D1 sessions table"
      via: "scheduled handler calls cleanupExpiredSessions"
      pattern: "cleanupExpiredSessions"
---

<objective>
Apply security headers globally on both the backend API Worker and the rwsdk app, add magic byte file validation to both resume upload paths, and wire session cleanup into the existing daily cron job.

Purpose: Close SEC-01 (security headers), SEC-03 (file upload validation), and SEC-04 (session cleanup) — the three security requirements that need no new npm dependencies and can be implemented with built-in platform features.

Output: Both Workers respond with proper security headers, file uploads are validated by content (not just MIME type), and expired D1 sessions are deleted nightly.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-error-handling/03-RESEARCH.md

@packages/backend/src/index.ts
@src/app/headers.ts
@packages/backend/src/routes/resumes.ts
@src/app/api/resume-upload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply security headers on both Workers</name>
  <files>
    packages/backend/src/index.ts
    src/app/headers.ts
  </files>
  <action>
**Backend API Worker (`packages/backend/src/index.ts`):**
Import `secureHeaders` from `hono/secure-headers`. Add `app.use(secureHeaders({...}))` BEFORE any route mounts. Configure:
- `strictTransportSecurity`: `'max-age=63072000; includeSubDomains; preload'`
- `xFrameOptions`: `'SAMEORIGIN'`
- `contentSecurityPolicy` with `defaultSrc: ["'self'"]`, `scriptSrc: ["'self'"]`, `styleSrc: ["'self'", "https://fonts.googleapis.com"]`, `fontSrc: ["'self'", "https://fonts.gstatic.com"]`, `objectSrc: ["'none'"]`, `frameAncestors: ["'none'"]`

The backend currently has NO security headers at all, so this is a fresh addition.

**rwsdk App (`src/app/headers.ts`):**
The existing `setCommonHeaders()` already sets HSTS, X-Content-Type-Options, Referrer-Policy, Permissions-Policy, and a CSP. Make these changes:
1. Add `X-Frame-Options: SAMEORIGIN` header (currently missing entirely)
2. Audit the existing CSP — keep `'unsafe-eval'` in script-src (rwsdk may require it for module loading), but note it in a comment
3. Keep `rw.nonce` usage intact — the nonce pattern is how rwsdk handles inline scripts securely
4. Do NOT remove `style-src 'unsafe-inline'` yet — React inline style props (style={{}}) are safe but the rwsdk framework itself may inject style tags. Add a comment noting this is intentional.
5. Add `frame-ancestors 'self'` to CSP if not already present (belt-and-suspenders with X-Frame-Options)

IMPORTANT: Do NOT convert React style={{}} props to Tailwind — React applies these via the DOM API and they are NOT blocked by CSP (see research Pitfall 1).
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/backend to confirm no type errors. Grep both files for the new headers:
- `grep -n "secureHeaders\|X-Frame-Options" packages/backend/src/index.ts`
- `grep -n "X-Frame-Options\|frame-ancestors" src/app/headers.ts`
  </verify>
  <done>
Both Workers include CSP, HSTS, and X-Frame-Options headers. The backend has secureHeaders middleware. The rwsdk app has X-Frame-Options added to its existing header middleware.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add magic byte file validation and session cleanup</name>
  <files>
    packages/backend/src/routes/resumes.ts
    src/app/api/resume-upload.ts
    packages/backend/src/index.ts
  </files>
  <action>
**Magic Byte Validation (SEC-03):**

Create a shared utility function `validateFileMagicBytes(buffer: ArrayBuffer, declaredType: string): boolean` that checks the first bytes of uploaded files:
- PDF: bytes 0-3 must be `0x25 0x50 0x44 0x46` (`%PDF`)
- Text/plain: attempt `new TextDecoder('utf-8', { fatal: true }).decode(buffer.slice(0, 1024))` — if it throws, reject

Place this function in a location accessible to both upload paths. Options: `packages/backend/src/utils/file-validation.ts` for the backend, inline or import in the rwsdk path.

**In `packages/backend/src/routes/resumes.ts`:**
Find the resume upload handler. BEFORE any parsing logic, read the first 8 bytes with `file.slice(0, 8).arrayBuffer()`, call `validateFileMagicBytes()`. If invalid, return `c.json({ error: 'File content does not match declared type' }, 400)`. Only then read the full file.

**In `src/app/api/resume-upload.ts`:**
Same pattern — validate magic bytes BEFORE calling `parseResumeWithAI()` or any processing. Return a 400 error response if invalid.

IMPORTANT: Read only the first 8 bytes for the check (Pitfall 5 from research). Do NOT read the entire file into memory before validating.

**Session Cleanup (SEC-04):**

In `packages/backend/src/index.ts`, find the `scheduled()` handler (already configured with cron `"0 1 * * *"` in wrangler.toml). Add a `cleanupExpiredSessions(env)` call using `ctx.waitUntil()`:

```typescript
async function cleanupExpiredSessions(env: Env): Promise<void> {
  const now = Math.floor(Date.now() / 1000);
  const result = await env.DB.prepare(
    'DELETE FROM sessions WHERE expires_at < ?'
  ).bind(now).run();
  console.log(`[SessionCleanup] Deleted ${result.meta.changes} expired sessions`);
}
```

The D1 sessions table already has `expires_at` column and `idx_sessions_expires_at` index, so this query is efficient. KV sessions auto-expire via TTL and do not need cleanup.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/backend to confirm no type errors. Verify:
- `grep -n "validateFileMagicBytes" packages/backend/src/routes/resumes.ts src/app/api/resume-upload.ts`
- `grep -n "cleanupExpiredSessions" packages/backend/src/index.ts`
  </verify>
  <done>
Both resume upload paths reject files whose magic bytes don't match the declared MIME type with a 400 error before any parsing. The backend scheduled handler cleans up expired D1 sessions on the daily cron run.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/backend (no type errors)
2. Security headers exist in both Workers: secureHeaders in backend index.ts, X-Frame-Options in headers.ts
3. Magic byte validation exists in both resume upload paths
4. Session cleanup function exists in the scheduled handler
5. No existing functionality is broken (existing route handlers, cron job import still work)
</verification>

<success_criteria>
- curl -I against any backend endpoint shows CSP, HSTS, X-Frame-Options headers
- Uploading a non-PDF file with .pdf extension returns 400 before parsing
- The scheduled handler includes session cleanup alongside existing job imports
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-error-handling/03-01-SUMMARY.md`
</output>
