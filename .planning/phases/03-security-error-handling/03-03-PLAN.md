---
phase: 03-security-error-handling
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - packages/backend/src/utils/errors.ts
  - packages/backend/src/index.ts
  - packages/backend/src/routes/auth.ts
  - packages/backend/src/routes/jobs.ts
  - packages/backend/src/routes/profile.ts
  - packages/backend/src/routes/resumes.ts
  - packages/backend/src/routes/applications.ts
autonomous: true
requirements:
  - ERR-01
  - ERR-02

must_haves:
  truths:
    - "Throwing NotFoundError in a route handler results in a 404 JSON response with the error message"
    - "Throwing ValidationError results in a 400, ForbiddenError in a 403, UnauthorizedError in a 401"
    - "Unhandled errors still return a generic 500 JSON response"
    - "All typed error responses follow the same JSON shape: { error: string }"
  artifacts:
    - path: "packages/backend/src/utils/errors.ts"
      provides: "Typed error classes with HTTP status codes"
      exports: ["AppError", "NotFoundError", "ValidationError", "ForbiddenError", "UnauthorizedError"]
    - path: "packages/backend/src/index.ts"
      provides: "Global error handler that checks instanceof AppError"
      contains: "instanceof AppError"
  key_links:
    - from: "packages/backend/src/index.ts"
      to: "packages/backend/src/utils/errors.ts"
      via: "app.onError checks instanceof AppError for status code"
      pattern: "instanceof AppError"
    - from: "packages/backend/src/routes/*.ts"
      to: "packages/backend/src/utils/errors.ts"
      via: "throw new NotFoundError/ValidationError/ForbiddenError"
      pattern: "throw new (NotFound|Validation|Forbidden|Unauthorized)Error"
---

<objective>
Create typed error classes with HTTP status codes and update the global error handler to return correct status codes and consistent JSON responses.

Purpose: Close ERR-01 (typed error classes) and ERR-02 (global error handler). Currently the backend uses generic `throw new Error()` with catch blocks that guess the status code. Typed errors make the error→response mapping explicit and consistent.

Output: Error classes for 400/401/403/404 with a global onError handler that maps them to JSON responses, plus key route handlers updated to throw typed errors.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-security-error-handling/03-RESEARCH.md
@.planning/phases/03-security-error-handling/03-01-SUMMARY.md

@packages/backend/src/utils/errors.ts
@packages/backend/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create typed error classes and update global error handler</name>
  <files>
    packages/backend/src/utils/errors.ts
    packages/backend/src/index.ts
  </files>
  <action>
**Update `packages/backend/src/utils/errors.ts`:**

This file already exists with a `toMessage()` helper from Phase 2. ADD (do not remove existing exports) the following error classes:

```typescript
export class AppError extends Error {
  constructor(
    public readonly statusCode: number,
    message: string
  ) {
    super(message);
    this.name = this.constructor.name;
  }
}

export class NotFoundError extends AppError {
  constructor(message = 'Not found') { super(404, message); }
}

export class ValidationError extends AppError {
  constructor(message = 'Validation failed') { super(400, message); }
}

export class ForbiddenError extends AppError {
  constructor(message = 'Forbidden') { super(403, message); }
}

export class UnauthorizedError extends AppError {
  constructor(message = 'Unauthorized') { super(401, message); }
}
```

**Update `packages/backend/src/index.ts` — global onError handler:**

Find the existing `app.onError()` handler (currently returns generic 500 for everything). Replace with:

```typescript
app.onError((err, c) => {
  if (err instanceof AppError) {
    return c.json({ error: err.message }, err.statusCode as any);
  }
  console.error('[UnhandledError]', err);
  return c.json({ error: 'Internal server error' }, 500);
});
```

Import `AppError` from `./utils/errors`. This preserves the generic 500 fallback for truly unexpected errors while routing typed errors to the correct status code.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/backend. Verify:
- `grep -n "class.*Error extends" packages/backend/src/utils/errors.ts`
- `grep -n "instanceof AppError" packages/backend/src/index.ts`
  </verify>
  <done>
AppError base class and NotFoundError, ValidationError, ForbiddenError, UnauthorizedError subclasses exist in errors.ts. The global onError handler returns the correct HTTP status code for typed errors and 500 for unhandled errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace key throw/catch patterns with typed errors in route handlers</name>
  <files>
    packages/backend/src/routes/auth.ts
    packages/backend/src/routes/jobs.ts
    packages/backend/src/routes/profile.ts
    packages/backend/src/routes/resumes.ts
    packages/backend/src/routes/applications.ts
  </files>
  <action>
Scan the route handler files for patterns where errors are thrown or caught with hardcoded status codes. Replace with typed error throws. The global onError handler (from Task 1) will convert these to the correct HTTP responses automatically.

**Pattern to find:** `catch (error) { ... return c.json({ error: ... }, 400|401|403|404) }`

**Replace with:** `throw new NotFoundError('Resource not found')` (or ValidationError, ForbiddenError, UnauthorizedError as appropriate) — let the error propagate to the global handler. Simplify catch blocks that only re-throw.

**Specific replacements to look for:**

In `auth.ts`:
- 401 responses for invalid credentials → `throw new UnauthorizedError('Invalid credentials')`
- 400 responses for missing fields → leave as-is if handled by Zod validator (Phase 2 already added validation)

In `jobs.ts`:
- 404 responses for job not found → `throw new NotFoundError('Job not found')`

In `profile.ts`:
- 404 responses for profile not found → `throw new NotFoundError('Profile not found')`

In `resumes.ts`:
- 400 responses for invalid file → `throw new ValidationError('Invalid file type')`
- 404 for resume not found → `throw new NotFoundError('Resume not found')`

In `applications.ts`:
- 404 for application not found → `throw new NotFoundError('Application not found')`
- 403 for unauthorized access → `throw new ForbiddenError('Not authorized to access this application')`

**Rules:**
- Do NOT change Zod validation middleware responses (those already return structured 400s via validationHook from Phase 2)
- Do NOT change auth middleware responses (requireAuth, requireAdmin — those return their own 401/403)
- Only change catch blocks where a route handler manually constructs an error JSON response
- Import typed errors from `../utils/errors` in each file
- If a try-catch only existed to format the error response and the typed error now handles that, the try-catch can be simplified or removed — but keep the try-catch if it does cleanup or logging beyond error formatting
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/backend. Verify typed errors are used:
- `grep -rn "throw new.*Error" packages/backend/src/routes/`
- Confirm no route handler manually returns a 404/400/401/403 JSON that could use typed errors instead
  </verify>
  <done>
Key route handlers throw typed errors (NotFoundError, ValidationError, ForbiddenError, UnauthorizedError) instead of manually constructing error JSON responses with hardcoded status codes. The global error handler converts all typed errors to consistent JSON responses.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/backend
2. Typed error classes exist with correct status codes (400, 401, 403, 404)
3. Global onError handler checks instanceof AppError
4. Route handlers use typed error throws for common error cases
5. Zod validation and auth middleware responses are untouched
</verification>

<success_criteria>
- Throwing NotFoundError('Job not found') from a route handler returns `{ "error": "Job not found" }` with HTTP 404
- Throwing ValidationError('Invalid file') returns 400
- Unknown errors still return 500 with generic message
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-security-error-handling/03-03-SUMMARY.md`
</output>
