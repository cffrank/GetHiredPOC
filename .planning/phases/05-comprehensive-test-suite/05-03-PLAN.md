---
phase: 05-comprehensive-test-suite
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/frontend/vitest.config.ts
  - packages/frontend/test/setup.ts
  - packages/frontend/test/msw/server.ts
  - packages/frontend/test/msw/handlers.ts
  - packages/frontend/test/components/Profile.test.tsx
  - packages/frontend/test/components/Applications.test.tsx
  - packages/frontend/test/components/JobDetail.test.tsx
  - packages/frontend/package.json
autonomous: true
requirements:
  - TEST-04

must_haves:
  truths:
    - "Running npm test in packages/frontend executes component tests for Profile, Applications, and JobDetail pages and all pass"
    - "Profile test renders the profile page with user data from MSW mock and verifies key fields are displayed"
    - "Applications test renders the applications list from MSW mock data and verifies application cards appear"
    - "JobDetail test renders job details and handles the safeParseJSON edge case for malformed requirements"
  artifacts:
    - path: "packages/frontend/vitest.config.ts"
      provides: "Frontend vitest config with jsdom environment"
      contains: "jsdom"
    - path: "packages/frontend/test/setup.ts"
      provides: "Test setup with jest-dom matchers and MSW lifecycle"
      contains: "server.listen"
    - path: "packages/frontend/test/msw/server.ts"
      provides: "MSW server instance for Node"
      contains: "setupServer"
    - path: "packages/frontend/test/msw/handlers.ts"
      provides: "Default MSW request handlers for API endpoints"
      contains: "http.get"
    - path: "packages/frontend/test/components/Profile.test.tsx"
      provides: "Profile page component tests"
      contains: "Profile"
    - path: "packages/frontend/test/components/Applications.test.tsx"
      provides: "Applications page component tests"
      contains: "Applications"
    - path: "packages/frontend/test/components/JobDetail.test.tsx"
      provides: "JobDetail page component tests"
      contains: "JobDetail"
  key_links:
    - from: "packages/frontend/test/setup.ts"
      to: "packages/frontend/test/msw/server.ts"
      via: "import server for beforeAll/afterEach/afterAll lifecycle"
      pattern: "import.*server"
    - from: "packages/frontend/test/components/Profile.test.tsx"
      to: "packages/frontend/src/pages/Profile.tsx"
      via: "import and render in test"
      pattern: "import.*Profile"
---

<objective>
Set up frontend test infrastructure (Vitest + jsdom + MSW) and create component tests for Profile, Applications, and JobDetail pages.

Purpose: Satisfy TEST-04 — frontend component tests for Profile, Applications, and JobDetail pages that pass when running `npm test` in the frontend workspace.
Output: Vitest config, MSW setup, test setup file, and 3 component test files in `packages/frontend/test/`.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-comprehensive-test-suite/05-RESEARCH.md

@packages/frontend/package.json
@packages/frontend/src/pages/Profile.tsx
@packages/frontend/src/pages/Applications.tsx
@packages/frontend/src/pages/JobDetail.tsx
@packages/frontend/src/context/AuthContext.tsx
@packages/frontend/src/lib/api-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps and set up frontend test infrastructure</name>
  <files>
    packages/frontend/package.json
    packages/frontend/vitest.config.ts
    packages/frontend/test/setup.ts
    packages/frontend/test/msw/server.ts
    packages/frontend/test/msw/handlers.ts
  </files>
  <action>
    **Step 1: Install test dependencies** in the frontend workspace:
    ```bash
    npm install -D vitest @testing-library/react @testing-library/user-event @testing-library/jest-dom jsdom msw --workspace=packages/frontend
    ```

    **Step 2: Add test script** to `packages/frontend/package.json`:
    Add `"test": "vitest run"` to the scripts section.

    **Step 3: Create `packages/frontend/vitest.config.ts`:**
    ```typescript
    import { defineConfig } from 'vitest/config';
    import react from '@vitejs/plugin-react';

    export default defineConfig({
      plugins: [react()],
      test: {
        globals: true,
        environment: 'jsdom',
        setupFiles: ['./test/setup.ts'],
      },
    });
    ```

    **Step 4: Create `packages/frontend/test/setup.ts`:**
    - Import and extend vitest expect with `@testing-library/jest-dom/matchers`
    - Import `cleanup` from `@testing-library/react` and call in `afterEach`
    - Import MSW server, call `server.listen({ onUnhandledRequest: 'error' })` in `beforeAll`
    - Call `server.resetHandlers()` in `afterEach`, `server.close()` in `afterAll`

    **Step 5: Create `packages/frontend/test/msw/server.ts`:**
    - Import `setupServer` from `msw/node`
    - Import `handlers` from `./handlers`
    - Export `const server = setupServer(...handlers)`

    **Step 6: Create `packages/frontend/test/msw/handlers.ts`:**
    - Read `packages/frontend/src/lib/api-client.ts` FIRST to identify the base URL and all API endpoints used
    - Read `packages/frontend/src/context/AuthContext.tsx` to identify the /api/auth/me call shape
    - Create default handlers for:
      - `GET /api/auth/me` — return a valid user object (this is CRITICAL: without it, ProtectedRoute redirects to login)
      - `GET /api/applications` — return `{ applications: [] }`
      - `GET /api/profile` — return a user profile object
      - `GET /api/jobs/:id` — return a single job object with valid fields
      - Any other endpoints the three test pages call on mount
    - Use the correct base URL from api-client.ts (likely `http://localhost:8787`)
    - Use MSW 2.x syntax: `http.get(url, () => HttpResponse.json(data))`

    **IMPORTANT:** The MSW handlers must return data shapes that match what the actual API returns. Read the page components to understand what fields they access from the API response.
  </action>
  <verify>
    Run `cd packages/frontend && npx vitest run --passWithNoTests` — exits 0 with no test files yet (just validates config).
    Verify `packages/frontend/package.json` has `"test": "vitest run"` in scripts.
  </verify>
  <done>Frontend test infrastructure is set up: vitest.config.ts with jsdom, test/setup.ts with jest-dom matchers and MSW lifecycle, MSW server and handlers covering auth/me and core API endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Create Profile, Applications, and JobDetail component tests</name>
  <files>
    packages/frontend/test/components/Profile.test.tsx
    packages/frontend/test/components/Applications.test.tsx
    packages/frontend/test/components/JobDetail.test.tsx
  </files>
  <action>
    **First:** Read all three page components (`Profile.tsx`, `Applications.tsx`, `JobDetail.tsx`) to understand:
    - What hooks they call (useQuery, useMutation, useAuth, useParams, etc.)
    - What API endpoints they fetch from
    - What data they render
    - What user interactions they support

    Also read `AuthContext.tsx` to understand the auth wrapper and what it provides.

    **Create a shared `renderWithProviders` helper** (inline in each test file or in a test utils file):
    ```typescript
    function renderWithProviders(ui: React.ReactElement, { route = '/' } = {}) {
      const queryClient = new QueryClient({
        defaultOptions: { queries: { retry: false }, mutations: { retry: false } },
      });
      return render(
        <QueryClientProvider client={queryClient}>
          <MemoryRouter initialEntries={[route]}>{ui}</MemoryRouter>
        </QueryClientProvider>
      );
    }
    ```
    NOTE: If pages use `useParams()` for route params (e.g., JobDetail uses `:id`), wrap in a `<Routes><Route path="/jobs/:id" element={ui} /></Routes>` inside MemoryRouter with the correct initialEntries.

    **Create `packages/frontend/test/components/Profile.test.tsx`:**
    - Override MSW handler for GET /api/profile to return profile data with full_name, email, phone, etc.
    - Test: renders the profile page and displays user's name
    - Test: shows loading state initially (if applicable)
    - Test: displays profile fields (email, phone, etc.)

    **Create `packages/frontend/test/components/Applications.test.tsx`:**
    - Override MSW handler for GET /api/applications to return 1-2 applications with job data
    - Test: renders applications and shows application cards with job title and company
    - Test: shows empty state when applications array is empty
    - Test: each application shows its status

    **Create `packages/frontend/test/components/JobDetail.test.tsx`:**
    - Override MSW handler for GET /api/jobs/:id to return a job object
    - If JobDetail uses useParams for the job ID, set up routing correctly with MemoryRouter
    - Test: renders job title, company, description
    - Test: handles malformed requirements JSON gracefully (the safeParseJSON fix from Phase 1)
    - Override the MSW handler to return a job with `requirements: 'not valid json'` and verify no crash

    **CRITICAL patterns:**
    - Use `await screen.findByText(...)` (not `getByText`) for async-loaded content
    - Each test creates its own QueryClient with `retry: false`
    - If AuthContext wraps the component, the MSW handler for GET /api/auth/me must return a valid user (already in default handlers from Task 1)
    - Use `server.use(http.get(...))` within individual tests to override default handlers
  </action>
  <verify>
    Run `cd packages/frontend && npm test` — all 3 component test files pass.
    Verify output shows Profile, Applications, and JobDetail test suites with passing assertions.
  </verify>
  <done>Profile test renders profile data from MSW mock. Applications test renders application list and empty state. JobDetail test renders job details and handles malformed JSON requirements. All pass via `npm test` in frontend workspace.</done>
</task>

</tasks>

<verification>
Run `cd packages/frontend && npm test` — all component tests pass.
Verify that Profile, Applications, and JobDetail pages each have at least 2 test cases.
</verification>

<success_criteria>
- `packages/frontend/vitest.config.ts` exists with jsdom environment
- `packages/frontend/test/setup.ts` wires jest-dom matchers and MSW lifecycle
- MSW handlers cover auth/me and core endpoints
- 3 component test files exist and pass
- `npm test` in frontend workspace exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/05-comprehensive-test-suite/05-03-SUMMARY.md`
</output>
