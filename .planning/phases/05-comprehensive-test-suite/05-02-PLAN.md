---
phase: 05-comprehensive-test-suite
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/test/integration/auth.routes.test.ts
  - packages/backend/test/integration/jobs.routes.test.ts
  - packages/backend/test/integration/applications.routes.test.ts
  - packages/backend/test/integration/profile.routes.test.ts
autonomous: true
requirements:
  - TEST-03

must_haves:
  truths:
    - "Running npm test in packages/backend executes integration tests for auth, jobs, applications, and profile route handlers"
    - "Auth route tests verify signup returns 201 with session cookie, login returns 200, logout clears cookie, /me returns user data with valid session"
    - "Jobs route tests verify GET /api/jobs returns paginated results with cursor, nextCursor, and hasMore fields"
    - "Applications route tests verify CRUD operations and auth guard returns 401 without session"
    - "Profile route tests verify GET returns user profile and PUT updates profile fields"
  artifacts:
    - path: "packages/backend/test/integration/auth.routes.test.ts"
      provides: "Auth route integration tests"
      contains: "app.request"
    - path: "packages/backend/test/integration/jobs.routes.test.ts"
      provides: "Jobs route integration tests"
      contains: "api/jobs"
    - path: "packages/backend/test/integration/applications.routes.test.ts"
      provides: "Applications route integration tests"
      contains: "api/applications"
    - path: "packages/backend/test/integration/profile.routes.test.ts"
      provides: "Profile route integration tests"
      contains: "api/profile"
  key_links:
    - from: "packages/backend/test/integration/auth.routes.test.ts"
      to: "packages/backend/src/index.ts"
      via: "import app, call app.request()"
      pattern: "import.*index"
    - from: "packages/backend/test/integration/auth.routes.test.ts"
      to: "packages/backend/src/routes/auth.ts"
      via: "HTTP request through Hono router"
      pattern: "app\\.request.*api/auth"
---

<objective>
Create backend integration tests for all core API route handlers using real D1 bindings.

Purpose: Satisfy TEST-03 — integration tests for all API route handlers using real D1 bindings via vitest-pool-workers that pass when running `npm test` in the backend workspace.
Output: 4 integration test files in `packages/backend/test/integration/` testing auth, jobs, applications, and profile routes.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-comprehensive-test-suite/05-RESEARCH.md

@packages/backend/vitest.config.mts
@packages/backend/test/smoke.test.ts
@packages/backend/src/index.ts
@packages/backend/src/routes/auth.ts
@packages/backend/src/routes/jobs.ts
@packages/backend/src/routes/applications.ts
@packages/backend/src/routes/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth and jobs route integration tests</name>
  <files>
    packages/backend/test/integration/auth.routes.test.ts
    packages/backend/test/integration/jobs.routes.test.ts
  </files>
  <action>
    **First:** Read `packages/backend/src/routes/auth.ts` and `packages/backend/src/routes/jobs.ts` to understand exact endpoints, request shapes, and response shapes.

    Create `packages/backend/test/integration/auth.routes.test.ts`:
    - Import `env` from `cloudflare:test`, import app from `../../src/index`
    - Create a helper function `createSessionCookie(email, password)` that calls `app.request('/api/auth/signup', ...)` and extracts the `Set-Cookie` header value (split on `;` to get `session=xxx` part)
    - Test POST /api/auth/signup: valid body returns 201 + Set-Cookie header with session
    - Test POST /api/auth/signup: duplicate email returns 400
    - Test POST /api/auth/signup: missing/invalid body returns 400 (Zod validation)
    - Test POST /api/auth/login: valid credentials return 200 + session cookie
    - Test POST /api/auth/login: wrong password returns 401
    - Test GET /api/auth/me: with valid session cookie returns user object
    - Test GET /api/auth/me: without cookie returns 401
    - Test POST /api/auth/logout: clears session cookie
    - Use unique emails per test: `auth-${Date.now()}-${Math.random().toString(36).slice(2)}@test.com`

    Create `packages/backend/test/integration/jobs.routes.test.ts`:
    - Import `env` from `cloudflare:test`, import app from `../../src/index`
    - Test GET /api/jobs: returns 200 with `{ jobs, nextCursor, hasMore }` shape
    - Test GET /api/jobs?limit=5: returns at most 5 jobs
    - Test GET /api/jobs with cursor parameter: returns next page (may need to seed jobs first via direct D1 insert if DB is empty)
    - If jobs table is empty after migrations, seed a few test jobs via `env.DB.prepare('INSERT INTO jobs ...').run()` in a beforeAll block
    - Test that the response shape matches the PaginatedJobs type (jobs array, nextCursor string|null, hasMore boolean)

    **Pattern:** Use `app.request(path, { method, headers, body }, env)` for all requests. The third argument passes the real D1 env to the Hono app. Read the Hono testing docs pattern from the research.
  </action>
  <verify>
    Run `cd packages/backend && npx vitest run test/integration/auth.routes.test.ts test/integration/jobs.routes.test.ts` — all tests pass.
  </verify>
  <done>Auth routes tested for signup/login/logout/me with session cookie handling. Jobs route tested for pagination shape and limit parameter.</done>
</task>

<task type="auto">
  <name>Task 2: Create applications and profile route integration tests</name>
  <files>
    packages/backend/test/integration/applications.routes.test.ts
    packages/backend/test/integration/profile.routes.test.ts
  </files>
  <action>
    **First:** Read `packages/backend/src/routes/applications.ts` and `packages/backend/src/routes/profile.ts` to understand exact endpoints, request/response shapes, and auth requirements.

    Create `packages/backend/test/integration/applications.routes.test.ts`:
    - Import `env` from `cloudflare:test`, import app from `../../src/index`
    - Reuse or recreate the `createSessionCookie` helper (or extract to a shared test util if useful)
    - Test GET /api/applications: returns 401 without session cookie
    - Test GET /api/applications: returns 200 with empty array for new user (with valid session)
    - Test POST /api/applications: creates an application (need to seed a job first via D1 insert — `INSERT INTO jobs (id, title, company, ...) VALUES (...)`)
    - Test PUT/PATCH /api/applications/:id: updates application status
    - Test that updating another user's application returns 403 (ForbiddenError)
    - Test that updating a non-existent application returns 404

    Create `packages/backend/test/integration/profile.routes.test.ts`:
    - Test GET /api/profile: returns 401 without session
    - Test GET /api/profile: returns user profile with valid session (after signup)
    - Test PUT /api/profile: updates profile fields (full_name, phone, etc.)
    - Read the profile route to confirm exact PUT body shape and which fields are updateable
    - Test that PUT /api/profile with invalid data returns 400 (Zod validation)

    **IMPORTANT:** Use unique emails per test. Seed any required related data (jobs for applications) via direct D1 inserts. Do NOT test routes that require AI binding (ai-jobs, recommendations, chat) — those need AI mocks which are out of scope for this plan.
  </action>
  <verify>
    Run `cd packages/backend && npx vitest run test/integration/` — all integration tests pass.
    Then run `cd packages/backend && npm test` — all tests pass (smoke + unit + integration).
  </verify>
  <done>Applications routes tested for CRUD with auth guards, ownership checks, and 404/403 error cases. Profile routes tested for GET/PUT with auth guard and validation.</done>
</task>

</tasks>

<verification>
Run `cd packages/backend && npm test` — all tests pass (smoke + unit + integration).
Verify that auth, jobs, applications, and profile routes all have test coverage.
</verification>

<success_criteria>
- 4 integration test files exist in `packages/backend/test/integration/`
- All integration tests use `app.request()` with real D1 env from `cloudflare:test`
- Auth routes: signup, login, logout, me all tested
- Jobs route: pagination shape tested
- Applications route: CRUD + auth guard tested
- Profile route: GET/PUT + auth guard tested
- `npm test` passes in backend workspace
</success_criteria>

<output>
After completion, create `.planning/phases/05-comprehensive-test-suite/05-02-SUMMARY.md`
</output>
