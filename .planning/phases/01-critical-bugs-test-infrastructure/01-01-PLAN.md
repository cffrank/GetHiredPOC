---
phase: 01-critical-bugs-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/vitest.config.mts
  - packages/backend/test/apply-migrations.ts
  - packages/backend/test/env.d.ts
  - packages/backend/test/smoke.test.ts
  - packages/backend/package.json
  - packages/backend/tsconfig.json
autonomous: true
requirements:
  - TEST-01

must_haves:
  truths:
    - "Running `npm test` in packages/backend executes at least one test against D1 via vitest-pool-workers"
    - "Tests run in the real Workers runtime, not a mock-patched environment"
    - "D1 migrations are applied automatically before tests run"
  artifacts:
    - path: "packages/backend/vitest.config.mts"
      provides: "Vitest pool-workers configuration with D1 migration loading"
      contains: "defineWorkersProject"
    - path: "packages/backend/test/apply-migrations.ts"
      provides: "Setup file that applies D1 migrations before each test run"
      contains: "applyD1Migrations"
    - path: "packages/backend/test/env.d.ts"
      provides: "TypeScript declarations for cloudflare:test ProvidedEnv"
      contains: "ProvidedEnv"
    - path: "packages/backend/test/smoke.test.ts"
      provides: "Smoke test proving D1 binding works"
      contains: "env.DB"
  key_links:
    - from: "packages/backend/vitest.config.mts"
      to: "migrations/"
      via: "readD1Migrations path resolution"
      pattern: "readD1Migrations.*migrations"
    - from: "packages/backend/test/apply-migrations.ts"
      to: "cloudflare:test"
      via: "applyD1Migrations import"
      pattern: "import.*applyD1Migrations.*cloudflare:test"
    - from: "packages/backend/test/smoke.test.ts"
      to: "env.DB"
      via: "D1 binding from cloudflare:test"
      pattern: "env\\.DB\\.prepare"
---

<objective>
Set up the backend test infrastructure using @cloudflare/vitest-pool-workers so tests run inside the real Workers runtime with real D1 bindings.

Purpose: Every subsequent bug fix and feature in all phases needs a working test harness. This plan creates the foundation that TEST-02 through TEST-05 will build on.
Output: A passing `npm test` command in packages/backend that executes a D1 smoke test.
</objective>

<execution_context>
@/home/carl/.claude/get-shit-done/workflows/execute-plan.md
@/home/carl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bugs-test-infrastructure/01-RESEARCH.md
@packages/backend/package.json
@packages/backend/tsconfig.json
@packages/backend/wrangler.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vitest and pool-workers, configure test runner</name>
  <files>
    packages/backend/package.json
    packages/backend/vitest.config.mts
    packages/backend/tsconfig.json
  </files>
  <action>
1. Install dev dependencies in the backend workspace:
   ```bash
   npm install --save-dev vitest @cloudflare/vitest-pool-workers --workspace=packages/backend
   ```

2. Add a `"test"` script to `packages/backend/package.json`:
   ```json
   "test": "vitest run"
   ```

3. Create `packages/backend/vitest.config.mts` with:
   ```typescript
   import path from "node:path";
   import { defineWorkersProject, readD1Migrations } from "@cloudflare/vitest-pool-workers/config";

   export default defineWorkersProject(async () => {
     const migrationsPath = path.join(__dirname, "../../migrations");
     const migrations = await readD1Migrations(migrationsPath);

     return {
       test: {
         setupFiles: ["./test/apply-migrations.ts"],
         poolOptions: {
           workers: {
             singleWorker: true,
             wrangler: { configPath: "./wrangler.toml" },
             miniflare: {
               bindings: { TEST_MIGRATIONS: migrations },
             },
           },
         },
       },
     };
   });
   ```

   CRITICAL: The migrations path MUST be `../../migrations` (relative to packages/backend/) — this is where wrangler.toml points (`migrations_dir = "../../migrations"`).

   CRITICAL: Do NOT set `environment` in the wrangler options — this project's wrangler.toml has no named environments.

4. Update `packages/backend/tsconfig.json`:
   - Add `"@cloudflare/vitest-pool-workers"` to the `types` array alongside `"@cloudflare/workers-types"`
   - Add `"test/**/*"` and `"vitest.config.mts"` to the `include` array
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/backend/tsconfig.json` — should compile without errors related to vitest or pool-workers types.
  </verify>
  <done>vitest.config.mts exists with defineWorkersProject, readD1Migrations pointed at ../../migrations, singleWorker: true, and wrangler configPath set. tsconfig.json includes test files and vitest types. package.json has "test" script.</done>
</task>

<task type="auto">
  <name>Task 2: Create test setup files and D1 smoke test</name>
  <files>
    packages/backend/test/apply-migrations.ts
    packages/backend/test/env.d.ts
    packages/backend/test/smoke.test.ts
  </files>
  <action>
1. Create `packages/backend/test/env.d.ts`:
   ```typescript
   import type { D1Database } from "@cloudflare/workers-types";

   declare module "cloudflare:test" {
     interface ProvidedEnv {
       DB: D1Database;
       TEST_MIGRATIONS: D1Migration[];
     }
   }
   ```
   The binding name `DB` must match the `[[d1_databases]]` binding in wrangler.toml.

2. Create `packages/backend/test/apply-migrations.ts`:
   ```typescript
   import { applyD1Migrations, env } from "cloudflare:test";

   await applyD1Migrations(env.DB, env.TEST_MIGRATIONS);
   ```
   This is a top-level await — the `.mts` config ensures ESM context. `applyD1Migrations` is idempotent.

3. Create `packages/backend/test/smoke.test.ts`:
   ```typescript
   import { env } from "cloudflare:test";
   import { describe, it, expect } from "vitest";

   describe("D1 smoke", () => {
     it("can execute SQL against the D1 binding", async () => {
       const result = await env.DB
         .prepare("SELECT COUNT(*) AS cnt FROM jobs")
         .first<{ cnt: number }>();
       expect(result?.cnt).toBeGreaterThanOrEqual(0);
     });
   });
   ```
   This proves the D1 binding is wired, migrations ran (the `jobs` table exists), and queries execute inside the real Workers runtime.

4. Run `npm test --workspace=packages/backend` and verify the smoke test passes.
  </action>
  <verify>
Run `npm test --workspace=packages/backend` — output should show 1 test passing in smoke.test.ts with no mock-related warnings.
  </verify>
  <done>`npm test` in packages/backend runs vitest, applies D1 migrations, and the smoke test querying `SELECT COUNT(*) FROM jobs` passes.</done>
</task>

</tasks>

<verification>
1. `npm test --workspace=packages/backend` passes with at least 1 test
2. The test output shows vitest-pool-workers running (not standard vitest)
3. The smoke test queries a real D1 table (`jobs`) proving migrations were applied
4. No mock patching of the Workers runtime appears anywhere in test files
</verification>

<success_criteria>
A developer can run `npm test` in packages/backend and execute at least one real test against the D1 binding via vitest-pool-workers without mock patching the Workers runtime.
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bugs-test-infrastructure/01-01-SUMMARY.md`
</output>
